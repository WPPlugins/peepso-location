!function(a,b,c){pslocation=new(function(a,b){function c(){this.coords=null,this.$places_container=null,this.$input_search=null,this.marker=null,this.map=null,this.selected_place=null,this._search_service=null,this._latLang=null,this.last_selected_place=null,this.location_selected=!1,this.can_submit=!1}return c.prototype.init=function(){if(!_.isNull(this.$postbox)){var a=this;ps_observer.add_filter("peepso_postbox_can_submit",function(b){return b.soft.push(a.can_submit),b},30,1),b(this.$postbox).on("click","#location-tab a",function(){a.toggle_input()}),this.$input_search=b("#postbox_loc_search",this.$postbox),this.$container=b("#pslocation",this.$postbox),this.$postboxcontainer=this.$postbox.$textarea.parent(),this.$places_container=b(".ps-postbox-locations",this.$container);var c=null;this.$input_search.on("keyup",function(){var d=this;clearTimeout(c);var e=b("<li>"+b("#pslocation-search-loading").html()+"</li>");a.$places_container.html(e),c=setTimeout(function(){a.location_search(b(d).val())},1500)}),ps_observer.add_filter("postbox_req_"+this.$postbox.guid,function(b,c){return a.postbox_request(b,c)},10,1),this.$postbox.on("postbox.post_cancel postbox.post_saved",function(b,c,d){a.postbox_cancel_saved(c,d)}),this.$select_location=b(".ps-location-action .ps-add-location",this.$container),this.$remove_location=b(".ps-location-action .ps-remove-location",this.$container),this.$select_location.on("click",function(b){b.preventDefault(),a.on_select_location()}),this.$remove_location.on("click",function(b){b.preventDefault(),a.on_remove_location()}),b(this.$postbox).on("peepso.interaction-hide","#location-tab a",function(){a.$container.addClass("hidden")}),ps_observer.add_filter("peepso_postbox_addons_update",function(b){return a.location_selected&&b.unshift("<b><i class=ps-icon-map-marker></i>"+a.location_selected+"</b>"),b},10,1)}},c.prototype.postbox_request=function(a,b){return null!==this.selected_place&&(a.location={name:this.selected_place.name,latitude:this.selected_place.geometry.location.lat(),longitude:this.selected_place.geometry.location.lng()}),a},c.prototype.postbox_cancel_saved=function(a,b){this.$container.addClass("hidden"),this.$input_search.val(""),this.$remove_location.hide(),this.$select_location.show(),this.$postboxcontainer.find("span#postlocation").remove(),this.selected_place=null,this.location_selected=!1,this.can_submit=!1,this.$postbox.on_change()},c.prototype.set_postbox=function(a){this.$postbox=a},c.prototype.location_search=function(a,b){var c=this;if(_.isEmpty(this.map)&&(this._latLang=new google.maps.LatLng(0,0),this.draw_map(this._latLang)),_.isEmpty(a))return void this.draw_map(this._latLang);this.get_search_service().textSearch({query:a,location:this._latLang,radius:5e4},function(a,d){c.set_places(a,d),c.$select_location.is(":visible")||c.$places_container.find("li").first().trigger("click"),typeof Function==typeof b&&b()})},c.prototype.on_select_location=function(){null===this.selected_place&&(this.selected_place=this.last_selected_place),this.$select_location.hide(),this.$remove_location.show(),this.$container.addClass("hidden"),this.location_selected="",this.selected_place&&(this.location_selected=this.selected_place.name),this.can_submit=!0,this.$postbox.on_change()},c.prototype.on_remove_location=function(){this.$select_location.show(),this.$remove_location.hide(),this.selected_place=null,this.$postboxcontainer.find("span#postlocation").remove(),this.$container.addClass("hidden"),this.location_selected=!1,this.can_submit=!1,this.$postbox.on_change()},c.prototype.toggle_input=function(){if(this.$container.toggleClass("hidden"),this.$input_search.val(""),this.location=null,!this.$container.hasClass("hidden")){var a=this;this.load_library(function(){a.shown()}.bind(a))}},c.prototype.shown=function(){var a=this;this.$input_search.focus(),!1!==_.isEmpty(this.map)&&this.detect_location().done(function(b,c){a.draw_default_map(b,c)}).fail(function(){a.draw_default_map()})},c.prototype.draw_default_map=function(a,b){if(a&&b){var c=new google.maps.LatLng(a,b);this.draw_map(c)}else{this.$postbox.find(".ps-postbox-map").show(),this.$input_search.removeAttr("disabled"),this.$input_search.focus()}},c.prototype.draw_map=function(a,c){if(!1===_.isBoolean(c)&&(c=!0),!1!=a instanceof google.maps.LatLng){var d=this.$postbox.find(".ps-postbox-map");b("#pslocation .ps-postbox-loading",this.$postbox).hide(),d.show(),this.$input_search.removeAttr("disabled");var e=this;this._latLang=a;var f={center:a,zoom:15,draggable:!1,scrollwheel:!1,disableDefaultUI:!0};if(ps_observer.apply_filters("ps_location_before_draw_map",b("#pslocation",this.$postbox)),_.isEmpty(this.map)?(this.map=new google.maps.Map(d.get(0),f),this.marker=new google.maps.Marker({position:f.center,map:this.map,title:"You are here (more or less)"})):this.set_map_center(this._latLang),c){var g={location:this._latLang,types:["establishment"],rankBy:google.maps.places.RankBy.DISTANCE};this.get_search_service().nearbySearch(g,function(a,b){e.set_places(a,b),e.$select_location.is(":visible")||e.$places_container.find("li").first().trigger("click")})}}},c.prototype.get_search_service=function(){return _.isEmpty(this.search_service)&&(this._search_service=new google.maps.places.PlacesService(this.map)),this._search_service},c.prototype.set_places=function(a,c){var d=this;if(this.$places_container.find("li").remove(),c===google.maps.places.PlacesServiceStatus.OK)for(var e=0;e<a.length;e++)this.add_place(a[e]);b("li",this.$places_container).on("click",function(){b(".ps-location-action",this.$container).show(),d.$select_location.show(),d.$remove_location.hide()})},c.prototype.add_place=function(a){if(_.isEmpty(a.formatted_address)||(a.vicinity=a.formatted_address),!_.isEmpty(a.vicinity)){var c=this,d=b("<li></li>");d.append("<p class='reset-gap'>"+a.name+"</p>"),d.append("<span>"+a.vicinity+"</span>"),this.$places_container.append(d),d.on("click",function(){c.set_map_center(a.geometry.location),c.$input_search.val(a.name),c.selected_place=a,c.last_selected_place=c.selected_place})}},c.prototype.set_map_center=function(a){this.map.setCenter(a),this.marker.setPosition(a)},c.prototype.load_library=function(b){if(this.gmap_is_loaded)return void b();if(this.load_library_callbacks||(this.load_library_callbacks=[]),this.load_library_callbacks.push(b),!this.gmap_is_loading){this.gmap_is_loading=!0;var c=document.createElement("script"),d=peepsogeolocationdata.api_key,e=this;c.type="text/javascript",c.src="https://maps.googleapis.com/maps/api/js?libraries=places"+(d?"&key="+d:"")+"&callback=ps_gmap_callback",a.ps_gmap_callback=function(){for(e.gmap_is_loaded=!0,e.gmap_is_loading=!1;e.load_library_callbacks.length;)e.load_library_callbacks.shift()();delete a.ps_gmap_callback},document.body.appendChild(c)}},c.prototype.show_map=function(a,c,d){peepso.lightbox([{content:'<div class="ps-js-mapct" style="width:700px;height:400px;display:inline-block" />'}],{simple:!0,nofulllink:!0,afterchange:b.proxy(function(b){this.load_library(function(){var d=b.$container.find(".ps-js-mapct"),e=new google.maps.LatLng(a,c),f=new google.maps.Map(d[0],{center:e,zoom:14});new google.maps.Marker({position:e,map:f})})},this)})},c.prototype.init_location_search=function(a){if(!a.data("location-search")){a.data("location-search",1);var c=peepsogeolocationdata.template_selector,d=b(c),e=(d.children(".ps-js-location"),d.find(".ps-js-location-map")),f=d.find(".ps-js-location-list"),g=d.find(".ps-js-close"),h=d.find(".ps-js-select"),i=d.find(".ps-js-remove"),j=d.find(".ps-js-location-loading"),k=d.find(".ps-js-location-result"),l=d.find(".ps-js-location-placeholder"),m=d.find(".ps-js-location-listitem").get(0).outerHTML;a.on("input.ps-location",b.proxy(_.debounce(function(a){var b=a.target.value;b&&(l&&(l.remove(),l=null),k.hide(),j.show(),d.show(),this.search(b).done(function(a){var b,c,e,g=[];for(e=0;e<a.length;e++)b=a[e].description,b=b.split(/,\s(.+)?/),c=m.replace("{place_id}",a[e].place_id).replace("{name}",b[0]).replace("{description}",b[1]||"&nbsp;"),g.push(c);f.html(g.join("")),j.hide(),k.show(),d.show()}))},200),this)),a.on("blur.ps-location",b.proxy(function(b){d.hide(),h.hide(),a.val(a.data("location")||""),a.data("location")&&i.show()},this)),a.on("focus.ps-location",b.proxy(function(a){f.find(".ps-location-selected").removeClass("ps-location-selected"),d.show()},this)),f.on("mousedown","a.ps-js-location-listitem",b.proxy(function(c){var d=b(c.currentTarget),f=(d.find(".ps-js-location-listitem-name").text(),d.data("place-id"));c.preventDefault(),c.stopPropagation(),d.addClass("ps-location-selected"),d.siblings().removeClass("ps-location-selected"),h.show(),i.hide(),e.show(),this._gmap_get_place_detail(f).done(b.proxy(function(b){var c=b.name,d=b.geometry.location;a.data("tmp-location",c).data("tmp-latitude",d.lat()).data("tmp-longitude",d.lng()),this._gmap_render_map(e[0],b)},this))},this)),g.on("mousedown",function(){a.trigger("blur.ps-location")}),h.on("mousedown",function(b){b.preventDefault(),b.stopPropagation(),a.data("location",a.data("tmp-location")),a.data("latitude",a.data("tmp-latitude")),a.data("longitude",a.data("tmp-longitude")),a.val(a.data("location")),h.hide(),i.show(),a.trigger("blur.ps-location")}),i.on("mousedown",function(b){b.preventDefault(),b.stopPropagation(),a.removeData("location").removeData("latitude").removeData("longitude").val(""),f.find(".ps-location-selected").removeClass("ps-location-selected"),i.hide(),e.hide()}),d.insertAfter(a)}},c.prototype.search=function(a){return b.Deferred(b.proxy(function(b){this._gmap_get_autocomplete_service().done(function(c){c.getPlacePredictions({input:a},function(a,c){"OK"===c&&b.resolve(a)})})},this))},c.prototype.detect_location=function(){var c=this;return b.Deferred(function(b){"https:"!==a.location.protocol?b.reject():c.detect_location_by_device().done(function(a,c){b.resolve(a,c)}).fail(function(){c.detect_location_by_gmap_api().done(function(a,c){b.resolve(a,c)}).fail(function(){c.detect_location_by_ip().done(function(a,c){b.resolve(a,c)}).fail(function(){b.reject()})})})})},c.prototype.detect_location_by_device=function(){return b.Deferred(b.proxy(function(a){navigator.geolocation.getCurrentPosition(function(b){a.resolve(b.coords.latitude,b.coords.longitude)},function(){a.reject()},{timeout:1e4})},this))},c.prototype.detect_location_by_gmap_api=function(){return b.Deferred(b.proxy(function(a){var c=peepsogeolocationdata.api_key;this._client_location?a.resolve(this._client_location):c?b.post("https://www.googleapis.com/geolocation/v1/geolocate?key="+c,function(b){a.resolve(b.location.lat,b.location.lng)}).fail(function(b){a.reject(b)}):a.reject()},this))},c.prototype.detect_location_by_ip=function(){return b.Deferred(b.proxy(function(a){var c;b.ajax({url:"//freegeoip.net/json/",dataType:"jsonp",success:function(b){var d=b.latitude,e=b.longitude;d&&e&&(c=!0,a.resolve(d,e))},complete:function(){c||a.reject()}})},this))},c.prototype._gmap_load_library=function(){return b.Deferred(b.proxy(function(a){this.load_library(function(){a.resolve()})},this))},c.prototype._gmap_get_autocomplete_service=function(){return b.Deferred(b.proxy(function(a){this._gmap_autocomplete_service?a.resolve(this._gmap_autocomplete_service):this._gmap_load_library().done(b.proxy(function(){this._gmap_autocomplete_service=new google.maps.places.AutocompleteService,a.resolve(this._gmap_autocomplete_service)},this))},this))},c.prototype._gmap_render_map=function(a,c){var d,e,f,g;c.geometry?(d=c.geometry.location,e=c.geometry.viewport):d=new google.maps.LatLng(c.latitude,c.longitude),a=b(a).show(),f=a.data("ps-map"),g=a.data("ps-map-marker"),f||(f=new google.maps.Map(a[0],{center:d,zoom:15,draggable:!1,scrollwheel:!1,disableDefaultUI:!0}),a.data("ps-map",f)),g||(g=new google.maps.Marker({position:d,map:f,title:"You are here (more or less)"}),a.data("ps-map-marker",g)),f.setCenter(d),g.setPosition(d),e?f.fitBounds(e):f.setZoom(15)},c.prototype._gmap_get_place_service=function(){return b.Deferred(b.proxy(function(a){this._gmap_place_service?a.resolve(this._gmap_place_service):this._gmap_load_library().done(b.proxy(function(){var b=document.createElement("div");document.body.appendChild(b),this._gmap_place_service=new google.maps.places.PlacesService(b),a.resolve(this._gmap_place_service)},this))},this))},c.prototype._gmap_get_place_detail=function(a){return b.Deferred(b.proxy(function(c){this._gmap_place_cache&&this._gmap_place_cache[a]?c.resolve(this._gmap_place_cache[a]):this._gmap_get_place_service().done(b.proxy(function(d){d.getDetails({placeId:a},b.proxy(function(b,d){"OK"===d?(this._gmap_place_cache||(this._gmap_place_cache={}),this._gmap_place_cache[a]=b,c.resolve(b)):c.reject(d)},this))},this))},this))},ps_observer.add_filter("peepso_postbox_addons",function(a){return a.push(new c),a},10,1),c}(a,b)),ps_observer.add_filter("photo_create_album",function(a){var b=a.popup,c=b.find(".ps-js-location");return pslocation.init_location_search(c),a},10,1),b(function(){ps_observer.add_filter("profile_field_save",function(a,b){if(b.hasClass("ps-js-field-location")){var c=b.data();if(c.location&&c.latitude&&c.longitude)return JSON.stringify({name:c.location,latitude:c.latitude,longitude:c.longitude})}return a},10,2),ps_observer.add_action("profile_field_save_register",function(a){if(a.hasClass("ps-js-field-location")){var c,d=a.data();d.location&&d.latitude&&d.longitude&&(c=b('<input type="hidden" name="'+a.attr("name")+'" />'),a.removeAttr("name"),c.insertAfter(a),c.val(JSON.stringify({name:d.location,latitude:d.latitude,longitude:d.longitude})))}},10,1),b(".ps-js-field-location").each(function(){pslocation.init_location_search(b(this))})}),b(function(){var a,c=b(".ps-js-album-location"),d=c.find(".ps-js-album-location-text"),e=c.find(".ps-js-album-location-empty"),f=c.find(".ps-js-album-location-editor"),g=c.find(".ps-js-album-location-edit"),h=c.find(".ps-js-album-location-remove"),i=(f.find(".ps-js-submit"),f.find("input").eq(0));g.click(function(){f.is(":visible")||(d.hide(),e.hide(),g.hide(),h.hide(),f.show(),i.data("original-value",a=i.val()),i.focus().val("").val(a),pslocation.init_location_search(i),f.off("click input"),f.on("click",".ps-js-cancel",function(){i.val(a),f.off("click").hide(),g.show(),a?(d.show(),h.show()):e.show()}),f.on("click",".ps-js-submit",b.proxy(function(a){var c=i.data(),j={user_id:peepsodata.userid,post_id:c.postId,type_extra_field:"location","location[name]":c.location,"location[latitude]":c.latitude,"location[longitude]":c.longitude,_wpnonce:b("#_wpnonce_set_album_location").val()};peepso.postJson("photosajax.set_album_extra_field",j,function(a){a.success&&(f.off("click").hide(),i.val(c.location),d.find("span").html(c.location),d.show(),e.hide(),g.show(),h.show())})},this)))}),h.click(function(){var a=h.data(),c={user_id:peepsodata.userid,post_id:a.postId,type_extra_field:"location",location:"",_wpnonce:b("#_wpnonce_set_album_location").val()};peepso.postJson("photosajax.set_album_extra_field",c,function(a){a.success&&(i.val(""),d.find("span").html(""),d.hide(),e.show(),h.hide())})})})}(window,jQuery),function(a,b){var c=function(a){function b(){this.__constructor.apply(this,arguments)}var c=".ps-postbox-location";return b.prototype={__constructor:function(b){this.postbox=b,this.$doc=a(document),this.$toggle=b.$tabContext.find("#location-tab"),this.$dropdown=b.$tabContext.find("#pslocation").html(peepsogeolocationdata.template_postbox),this.$input=this.$dropdown.find("input[type=text]"),this.$loading=this.$dropdown.find(".ps-js-location-loading"),this.$result=this.$dropdown.find(".ps-js-location-result"),this.$list=this.$dropdown.find(".ps-js-location-list"),this.$map=this.$dropdown.find(".ps-js-location-map"),this.$select=this.$dropdown.find(".ps-js-select"),this.$remove=this.$dropdown.find(".ps-js-remove"),this.listItemTemplate=peepso.template(this.$dropdown.find(".ps-js-location-fragment").text()),this.$toggle.on("click"+c,a.proxy(this.onToggle,this)),this.$input.on("input"+c,a.proxy(this.onInput,this)),this.$list.on("mousedown"+c,"a.ps-js-location-listitem",a.proxy(this.onSelectItem,this)),this.$select.on("mousedown"+c,a.proxy(this.onSelect,this)),this.$remove.on("mousedown"+c,a.proxy(this.onRemove,this)),b.add_action("update",this.update,10,2,this),b.add_filter("render_addons",this.render,10,1,this),b.add_filter("data",this.filterData,10,1,this),b.add_filter("data_validate",this.validate,10,2,this)},show:function(){this.$dropdown.removeClass("hidden"),this.$doc.on("click"+c,a.proxy(this.onDocumentClick,this)),this._needUpdate&&(this._needUpdate=!1,this._selected?(this.$map.show(),this.$select.hide(),this.$remove.show(),this.$result.show(),this.updateList([{place_id:"",name:this._selected.name,description:this._selected.description}]),this.updateMap({latitude:this._selected.latitude,longitude:this._selected.longitude,zoom:this._selected.zoom})):(this.$map.hide(),this.$select.hide(),this.$remove.hide(),this.$result.hide(),this.updateList([])))},hide:function(){this.$dropdown.addClass("hidden"),this.$doc.off("click"+c)},toggle:function(){this.$dropdown.hasClass("hidden")?this.show():this.hide()},search:function(b){this.$result.hide(),this.$loading.show(),pslocation.search(b).done(a.proxy(function(a){for(var b,c=[],d=0;d<a.length;d++)b=a[d].description,b=b.split(/,\s(.+)?/),c.push({place_id:a[d].place_id,name:b[0],description:b[1]});this.updateList(c),this.$loading.hide(),this.$result.show()},this))},filterData:function(a){return this._selected?a.location=this._selected:a.location="",a},validate:function(a,b){return!!this._selected||a},render:function(a){var b;return this._selected&&(b='<i class="ps-icon-map-marker"></i>',b+="<b>"+this._selected.name+"</b>",a.push(b)),a},update:function(a){a=a&&a.data||{},a.location?(this._selected={name:a.location.name,description:a.location.description,latitude:a.location.latitude,longitude:a.location.longitude,zoom:a.location.zoom},this.$input.data("location",a.location.name),this.$input.data("latitude",a.location.latitude),this.$input.data("longitude",a.location.longitude),this.$input.val(a.location.name)):this._selected=!1,this._needUpdate=!0,this.postbox.do_action("refresh")},updateList:function(a){for(var b=[],c=0;c<a.length;c++)b.push(this.listItemTemplate(a[c]));this.$list.html(b.join(""))},updateMap:function(b){pslocation._gmap_load_library().done(a.proxy(function(){this.$map.show(),pslocation._gmap_render_map(this.$map[0],b)},this))},select:function(a,b,c){},remove:function(){},destroy:function(){this.$toggle.off("click")},onToggle:_.throttle(function(b){b.preventDefault(),b.stopPropagation();var c=a(b.target);this.$dropdown.is(c)||this.$dropdown.find(c).length||this.toggle()},200),onInput:function(){var b=a.trim(this.$input.val());b&&(this.$result.hide(),this.$loading.show(),this._onInput(b))},_onInput:_.debounce(function(a){this.search(a)},200),onSelectItem:function(b){var c=a(b.currentTarget),d=(c.find(".ps-js-location-listitem-name").text(),c.data("place-id"));b.preventDefault(),b.stopPropagation(),c.addClass("ps-location-selected"),c.siblings().removeClass("ps-location-selected"),this.$select.show(),this.$remove.hide(),this.$map.show(),pslocation._gmap_get_place_detail(d).done(a.proxy(function(a){var b=a.name,c=a.geometry.location;this.$input.data("tmp-location",b).data("tmp-latitude",c.lat()).data("tmp-longitude",c.lng()),pslocation._gmap_render_map(this.$map[0],a)},this))},onSelect:function(a){a.preventDefault(),a.stopPropagation();var b=this.$input.data("tmp-location"),c=this.$input.data("tmp-latitude"),d=this.$input.data("tmp-longitude");this.$input.data("location",b),this.$input.data("latitude",c),this.$input.data("longitude",d),this.$input.val(b),this.$select.hide(),this.$remove.show(),this.$dropdown.addClass("hidden"),this._selected={name:b,latitude:c,longitude:d},this.postbox.do_action("refresh")},onRemove:function(a){a.preventDefault(),a.stopPropagation(),this.$input.removeData("location").removeData("latitude").removeData("longitude").val(""),this.$list.find(".ps-location-selected").removeClass("ps-location-selected"),this.$remove.hide(),this.$map.hide(),this._selected=!1,this.postbox.do_action("refresh")},onDocumentClick:function(b){a(b.target).closest(this.$toggle).length||this.hide()}},b}(a);ps_observer.add_action("postbox_init",function(a){new c(a)},10,1)}(jQuery);
//# sourceMappingURL=bundle.min.js.map